name: MLflow CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'
    
    - name: Check Environment
      run: |
        python --version
        pwd
        ls -F MLProject/
    
    - name: Install MLflow & Base Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools
        pip install -r MLProject/requirements.txt
    
    - name: Set MLflow Tracking URI
      run: |
        # Menggunakan folder lokal untuk tracking agar artifacts mudah ditemukan
        export MLFLOW_TRACKING_URI=file:///$(pwd)/mlruns
        echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI" >> $GITHUB_ENV

    - name: Run MLflow Project
      run: |
        # Menjalankan project yang ada di dalam folder MLProject
        mlflow run ./MLProject \
          --env-manager=local \
          --experiment-name="Diabetes-Prediction-CI" \
          -P data_path=diabetes_dataset_processed.csv \
          -P test_size=0.2 \
          -P random_state=42

    - name: Get Latest Run ID
      id: get_run_id
      run: |
        RUN_ID=$(python -c "
        import mlflow
        from mlflow.tracking import MlflowClient
        import os
        
        mlflow.set_tracking_uri('file:///' + os.getcwd() + '/mlruns')
        client = MlflowClient()
        experiment = client.get_experiment_by_name('Diabetes-Prediction-CI')
        
        if experiment:
            runs = client.search_runs(
                experiment_ids=[experiment.experiment_id],
                order_by=['start_time DESC'],
                max_results=1
            )
            print(runs[0].info.run_id if runs else 'None')
        else:
            print('None')
        ")
        
        if [ "$RUN_ID" == "None" ]; then
          echo "Error: No run ID found."
          exit 1
        fi
        
        echo "Detected Run ID: $RUN_ID"
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

    - name: Install Dependencies for Artifact Upload
      run: pip install PyDrive2

    - name: Upload Artifacts to Google Drive
      env:
        GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        RUN_ID: ${{ env.RUN_ID }}
      run: |
        cat > upload_script.py << 'EOF'
        import os, sys
        from pydrive2.auth import GoogleAuth
        from pydrive2.drive import GoogleDrive

        def upload():
            creds_content = os.environ.get('GDRIVE_CREDENTIALS')
            folder_id = os.environ.get('GDRIVE_FOLDER_ID')
            run_id = os.environ.get('RUN_ID')
            
            # Setup Auth
            with open('credentials.json', 'w') as f: f.write(creds_content)
            gauth = GoogleAuth()
            gauth.LoadCredentialsFile('credentials.json')
            drive = GoogleDrive(gauth)
            
            # Define Artifact Path
            artifacts_path = f"mlruns/1/{run_id}/artifacts"
            
            print(f"Uploading artifacts from: {artifacts_path}")
            
            # Upload Loop
            for root, dirs, files in os.walk(artifacts_path):
                for file in files:
                    local_path = os.path.join(root, file)
                    rel_path = os.path.relpath(local_path, artifacts_path)
                    
                    gfile = drive.CreateFile({
                        'title': f"{run_id}_{rel_path.replace('/', '_')}",
                        'parents': [{'id': folder_id}]
                    })
                    gfile.SetContentFile(local_path)
                    gfile.Upload()
                    print(f"Uploaded: {rel_path}")

            if os.path.exists('credentials.json'): os.remove('credentials.json')

        if __name__ == '__main__':
            upload()
        EOF
        
        python upload_script.py

    - name: Build Docker Image
      run: |
        mlflow models build-docker \
          -m "mlruns/1/${{ env.RUN_ID }}/artifacts/model" \
          -n "diabetes-prediction-model" \
          --enable-mlserver

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag Docker Image
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/diabetes-prediction-model"
        
        docker tag diabetes-prediction-model:latest $IMAGE_NAME:latest
        docker tag diabetes-prediction-model:latest $IMAGE_NAME:$TIMESTAMP
        
        echo "DOCKER_TAG_LATEST=$IMAGE_NAME:latest" >> $GITHUB_ENV
        echo "DOCKER_TAG_TIME=$IMAGE_NAME:$TIMESTAMP" >> $GITHUB_ENV

    - name: Push Docker Image
      run: |
        docker push ${{ env.DOCKER_TAG_LATEST }}
        docker push ${{ env.DOCKER_TAG_TIME }}

    - name: Create Docker Link File
      run: |
        echo "Docker Hub Repository: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/diabetes-prediction-model" > Tautan_ke_Docker_Hub.txt
        echo "Pull Command: docker pull ${{ env.DOCKER_TAG_LATEST }}" >> Tautan_ke_Docker_Hub.txt

    - name: Upload Docker Link Artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-hub-link
        path: Tautan_ke_Docker_Hub.txt

    - name: Workflow Summary
      if: always()
      run: |
        echo "### ðŸš€ MLflow CI/CD Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID:** ${{ env.RUN_ID }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Image:** ${{ env.DOCKER_TAG_LATEST }}" >> $GITHUB_STEP_SUMMARY
